<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Withdraw Funds - MoneyPilot</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <div class="container">
            <div class="logo">
                <h1>MoneyPilot</h1>
            </div>
            <nav>
                <a href="dashboard.html">Dashboard</a>
                <a href="withdraw.html" class="active">Withdraw</a>
                <a href="plans.html">Invest</a>
                <a href="#" id="logoutBtn">Logout</a>
            </nav>
        </div>
    </header>

    <div class="form-container">
        <h2>Withdraw Funds</h2>

        <div class="withdrawal-info">
            <div class="balance-card">
                <h3>Available Balance</h3>
                <p id="availableBalance">GHS 0.00</p>
            </div>

            <div class="kyc-warning" id="kycWarning">
                <p>⚠️ KYC verification is required before you can withdraw funds.</p>
                <a href="kyc.html" class="btn-action">Complete KYC Now</a>
            </div>

            <div class="plan-restrictions" id="planRestrictions">
                <h4>Withdrawal Limits by Plan:</h4>
                <ul>
                    <li><strong>Free:</strong> Maximum GHS 20 lifetime withdrawal</li>
                    <li><strong>Bronze:</strong> GHS 5,000 per transaction</li>
                    <li><strong>Silver:</strong> GHS 10,000 per transaction</li>
                    <li><strong>Gold:</strong> GHS 15,000 per transaction</li>
                    <li><strong>Platinum:</strong> GHS 20,000 per transaction</li>
                </ul>
            </div>
        </div>

        <form id="withdrawForm" style="display: none;">
            <div class="form-group">
                <label for="withdrawMethod">Withdrawal Method</label>
                <select id="withdrawMethod" name="method" required>
                    <option value="">Select Method</option>
                    <option value="mobile_mtn">MTN Mobile Money</option>
                    <option value="mobile_telecel">Telecel Cash</option>
                    <option value="bank">Bank Transfer</option>
                    <option value="crypto_btc">Bitcoin (BTC)</option>
                    <option value="crypto_trx">TRON (TRC20)</option>
                </select>
            </div>

            <div id="methodDetails">
                <!-- Dynamic content based on selected method -->
            </div>

            <div class="form-group">
                <label for="withdrawAmount">Amount (GHS)</label>
                <input type="number" id="withdrawAmount" name="amount" min="10" required>
                <small>Minimum withdrawal: GHS 10</small>
            </div>

            <div class="form-group">
                <label for="withdrawPin">Security PIN</label>
                <input type="password" id="withdrawPin" name="pin" maxlength="4" required 
                       placeholder="Enter your 4-digit PIN">
            </div>

            <button type="submit" class="btn-submit">Request Withdrawal</button>
        </form>
    </div>

    <script src="auth.js"></script>
    <script>
        class WithdrawalSystem {
            constructor() {
                this.auth = auth;
                this.currentUser = null;
                this.init();
            }

            init() {
                this.checkAuthentication();
                this.setupEventListeners();
                this.updateUI();
            }

            checkAuthentication() {
                if (!this.auth.isLoggedIn()) {
                    window.location.href = 'login.html';
                    return;
                }
                this.currentUser = this.auth.getCurrentUser();
                
                document.getElementById('logoutBtn').addEventListener('click', () => {
                    this.auth.logout();
                });
            }

            setupEventListeners() {
                // Withdrawal method change
                document.getElementById('withdrawMethod').addEventListener('change', (e) => {
                    this.updateMethodDetails(e.target.value);
                });

                // Withdraw form submission
                document.getElementById('withdrawForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.processWithdrawal();
                });
            }

            updateUI() {
                // Update balance
                document.getElementById('availableBalance').textContent = 
                    `GHS ${this.currentUser.balance.toFixed(2)}`;

                // Check KYC status
                if (this.currentUser.kycVerified) {
                    document.getElementById('kycWarning').style.display = 'none';
                    document.getElementById('withdrawForm').style.display = 'block';
                } else {
                    document.getElementById('kycWarning').style.display = 'block';
                    document.getElementById('withdrawForm').style.display = 'none';
                }

                // Check free user withdrawal limit
                if (this.currentUser.plan === 'free') {
                    const totalWithdrawn = this.getTotalWithdrawn();
                    if (totalWithdrawn >= 20) {
                        document.getElementById('withdrawForm').style.display = 'none';
                        document.getElementById('kycWarning').innerHTML = `
                            <p>⚠️ Free users can only withdraw GHS 20 lifetime. Upgrade to a paid plan for unlimited withdrawals.</p>
                            <a href="plans.html" class="btn-action">Upgrade Plan</a>
                        `;
                    }
                }
            }

            getTotalWithdrawn() {
                if (!this.currentUser.transactions) return 0;
                return this.currentUser.transactions
                    .filter(t => t.type === 'withdrawal' && t.status === 'completed')
                    .reduce((sum, t) => sum + Math.abs(t.amount), 0);
            }

            updateMethodDetails(method) {
                const detailsContainer = document.getElementById('methodDetails');
                let html = '';

                switch (method) {
                    case 'mobile_mtn':
                    case 'mobile_telecel':
                        html = `
                            <div class="form-group">
                                <label for="mobileNumber">Mobile Number</label>
                                <input type="tel" id="mobileNumber" name="mobileNumber" required 
                                       placeholder="Enter your mobile number">
                            </div>
                            <div class="form-group">
                                <label for="accountName">Account Name</label>
                                <input type="text" id="accountName" name="accountName" required 
                                       placeholder="Enter name as it appears on mobile money">
                            </div>
                        `;
                        break;

                    case 'bank':
                        html = `
                            <div class="form-group">
                                <label for="bankName">Bank Name</label>
                                <input type="text" id="bankName" name="bankName" required>
                            </div>
                            <div class="form-group">
                                <label for="accountNumber">Account Number</label>
                                <input type="text" id="accountNumber" name="accountNumber" required>
                            </div>
                            <div class="form-group">
                                <label for="accountHolder">Account Holder Name</label>
                                <input type="text" id="accountHolder" name="accountHolder" required>
                            </div>
                            <div class="form-group">
                                <label for="branchCode">Branch Code</label>
                                <input type="text" id="branchCode" name="branchCode">
                            </div>
                        `;
                        break;

                    case 'crypto_btc':
                    case 'crypto_trx':
                        html = `
                            <div class="form-group">
                                <label for="cryptoAddress">${method === 'crypto_btc' ? 'Bitcoin' : 'TRON'} Address</label>
                                <input type="text" id="cryptoAddress" name="cryptoAddress" required 
                                       placeholder="Enter your wallet address">
                            </div>
                            <div class="form-group">
                                <label for="cryptoNetwork">Network</label>
                                <input type="text" id="cryptoNetwork" value="${method === 'crypto_btc' ? 'BTC' : 'TRC20'}" readonly>
                            </div>
                        `;
                        break;
                }

                detailsContainer.innerHTML = html;
            }

            processWithdrawal() {
                const formData = new FormData(document.getElementById('withdrawForm'));
                const amount = parseFloat(formData.get('amount'));
                const method = formData.get('method');
                const pin = formData.get('pin');

                // Validation
                if (amount < 10) {
                    alert('Minimum withdrawal amount is GHS 10');
                    return;
                }

                if (amount > this.currentUser.balance) {
                    alert('Insufficient balance for withdrawal');
                    return;
                }

                // Check withdrawal limits based on plan
                if (!this.checkWithdrawalLimit(amount)) {
                    return;
                }

                // Check free user lifetime limit
                if (this.currentUser.plan === 'free') {
                    const totalWithdrawn = this.getTotalWithdrawn();
                    if (totalWithdrawn + amount > 20) {
                        alert('Free users can only withdraw GHS 20 lifetime. Upgrade to a paid plan.');
                        return;
                    }
                }

                // Simple PIN validation (in real app, this would be properly hashed and verified)
                if (pin.length !== 4 || !/^\d+$/.test(pin)) {
                    alert('Please enter a valid 4-digit PIN');
                    return;
                }

                // Create withdrawal transaction
                const transaction = {
                    id: this.generateId(),
                    type: 'withdrawal',
                    amount: -amount,
                    method: method,
                    description: `Withdrawal to ${method}`,
                    date: new Date().toISOString(),
                    status: 'pending',
                    details: this.getWithdrawalDetails(formData)
                };

                // Update user data
                this.currentUser.balance -= amount;
                if (!this.currentUser.transactions) this.currentUser.transactions = [];
                this.currentUser.transactions.push(transaction);

                // Save changes
                this.auth.updateUser(this.currentUser.id, {
                    balance: this.currentUser.balance,
                    transactions: this.currentUser.transactions
                });

                alert('Withdrawal request submitted! It will be processed within 24 hours.');
                document.getElementById('withdrawForm').reset();
                this.updateUI();
            }

            checkWithdrawalLimit(amount) {
                const limits = {
                    'free': 20,
                    'bronze': 5000,
                    'silver': 10000,
                    'gold': 15000,
                    'platinum': 20000
                };

                const limit = limits[this.currentUser.plan] || 0;
                
                if (amount > limit) {
                    alert(`Withdrawal limit for ${this.currentUser.plan} plan is GHS ${limit}. Please upgrade your plan.`);
                    return false;
                }

                return true;
            }

            getWithdrawalDetails(formData) {
                const method = formData.get('method');
                let details = {};

                switch (method) {
                    case 'mobile_mtn':
                    case 'mobile_telecel':
                        details = {
                            mobileNumber: formData.get('mobileNumber'),
                            accountName: formData.get('accountName')
                        };
                        break;
                    case 'bank':
                        details = {
                            bankName: formData.get('bankName'),
                            accountNumber: formData.get('accountNumber'),
                            accountHolder: formData.get('accountHolder'),
                            branchCode: formData.get('branchCode')
                        };
                        break;
                    case 'crypto_btc':
                    case 'crypto_trx':
                        details = {
                            address: formData.get('cryptoAddress'),
                            network: method === 'crypto_btc' ? 'BTC' : 'TRC20'
                        };
                        break;
                }

                return details;
            }

            generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }
        }

        // Initialize withdrawal system
        document.addEventListener('DOMContentLoaded', () => {
            new WithdrawalSystem();
        });
    </script>

    <style>
        .withdrawal-info {
            margin-bottom: 2rem;
        }

        .balance-card {
            background: linear-gradient(135deg, #2c5aa0, #1e3a8a);
            color: white;
            padding: 2rem;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .balance-card h3 {
            margin-bottom: 0.5rem;
            opacity: 0.9;
        }

        .balance-card p {
            font-size: 2rem;
            font-weight: bold;
            margin: 0;
        }

        .kyc-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 1.5rem;
            border-radius: 5px;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .plan-restrictions {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 5px;
            border-left: 4px solid #2c5aa0;
        }

        .plan-restrictions ul {
            margin: 0;
            padding-left: 1.5rem;
        }

        .plan-restrictions li {
            margin-bottom: 0.5rem;
        }

        .btn-action {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            background: #2c5aa0;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            margin-top: 1rem;
        }
    </style>
</body>

</html>
